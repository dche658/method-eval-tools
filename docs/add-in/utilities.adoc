= Method Evaluation Utilities
:imagesdir: ./images/util
:stylesdir: ./styles
:toc: left
:toclevels: 3
:stem:
:stylesheet: custom.css

== Introduction

The clinical laboratory method evaluation Excel add-in comes with a couple of 
utilities that are provided in the hope that they will be helpful for users.

However, users need to be aware of their risks and limitations in order to 
avoid misuse or misinterpretation. The aim of this guide is to help users 
understand some of those limitations.

== Reference Intervals

The reference interval tool enables the user to 
calculate a reference interval on population data using either the robust or 
non-parametric methods.

The first method uses Horn's biweight quantile approach, also known as the robust
method. It is useful for smaller data sets and is resistent to outliers. However,
the data needs to be distributed symmetrically. For populations with a skewed 
distribution the data can be transformed prior to analysis. Alternatively, data
below the median can be removed, and data above the median can be reflected where
the reflected value v = median - (x - median). Suppose the median is 100 and 
subsequent values for x are [105, 124, 135, ...]. The reflected values would be
[95, 76, 65, ...]. The combined data set can then be used as a symmetric pseudo-sample
to calculate the upper reference limit. If this approach is used, Horn suggests using
the non-parametric approach to define the lower reference limit of the reference
interval.

Horn PS, Pesce AJ, Copeland BE. A robust approach to reference interval estimation 
and evaluation. Clinical Chemistry. 1998. 44(3):622-631.

The non-parametric approach requires at least 120 individuals in order to 
estimate 90% confidence limits for lower and upper reference limits of the
reference interval. This works well for normally distributed data but the 
uncertainty about the upper reference limit can become quite large, so it 
is recommended that much larger data sets are used if the data is heavily
skewed.

A Box-Cox transformation of the data can be undertaken to normalise skewed data
prior to analysis using the robust approach. However, the selection of lambda, 
which is discussed below can be problematic if the data set is not large enough.
For this reason it is suggested that the robust approach only be used on smaller
data sets, say 50 - 200 subjects if the data is symmetrically distributed.

The simplest approach to assessing the distribution is to construct a histogram
of the data. Excel has a built in histogram chart tool which is available under
the Insert menu.

Skewness can also be assess using the Excel SKEW function.

The add-in also provides a custom function METOOLS.SHAPIROWILKW(x) that calculates
the Shapiro-Wilk W and returns this value with the level of significance. A p value
&lt; 0.05 typically is considered to indicate the data is not normally distributed.

image::refint-tool.png[]

* The reference interval data should be in a single column in Excel. Select the range
of cells containing the data and use the button to copy the range to the taskpane.
* Select the method you wish to use for calculating the reference interval. 
* You may use different reference interval limits if you wish. The default is for the 
reference interval to include 95% of the population (alpha = 0.05), and the confidence
limits to cover 90% (alpha = 0.10).
* Select the top left cell where you would like the reference interval to be 
saved and copy the cell reference to the add-in taskpane.
* Click the "Calculate" button to perform the analysis and copy the results to the
Excel worksheet.

=== Confidence Limits for Reference Intervals

Confidence limits for the reference limits are calculated using the method 
of Campbell and Gardiner rather than using the tabulated values in CLSI EP28-A3c.

Campbell MJ, Gardner MJ. Calculating confidence intervals for some non-parametric analyses.
Br Med J (Clin Res Ed). 1988 May 21;296(6634):1454-6. doi: 10.1136/bmj.296.6634.1454.
PMID: 3132290;

CLSI EP28-A3c 2010: 
Defining, Establishing, and Verifying ReferenceIntervals in the Clinical Laboratory, 
3rd Edition.

The tabulated values reproduced below are based on Reed AH, 
Henry RJ, Mason WB. Influence of statistical method used on the resulting estimate
of normal range. Clin Chem. 1971 Apr;17(4):275-84. PMID: 5552364

.Nonparametric Confidence Intervals of Reference Limits.
From CLSI EP28-A3c
[cols="1,1,1,1,1,1"]
|===					
^|Sample Size
^|Lower
^|Upper
^|Sample Size
^|Lower
^|Upper
^|119-132
^|1
^|7 
^|566-574
^|8 
^|22
^|133-160
^|1
^|8 
^|575-598
^|9 
^|2
^|161-187
^|1
^|9 
^|599-624
^|9 
^|3
^|188-189
^|2
^|9 
^|625-631
^|10
^|3
^|190-218
^|2
^|10
^|632-665
^|10
^|4
^|219-248
^|2
^|11
^|666-674
^|10
^|5
^|249-249
^|2
^|12
^|675-698
^|11
^|5
^|250-279
^|3
^|12
^|699-724
^|11
^|6
^|280-307
^|3
^|13
^|725-732
^|12
^|6
^|308-309
^|4
^|13
^|733-765
^|12
^|7
^|310-340
^|4
^|14
^|766-773
^|12
^|8
^|341-363
^|4
^|15
^|774-799
^|13
^|8
^|364-372
^|5
^|15
^|800-822
^|13
^|9
^|373-403
^|5
^|16
^|823-833
^|14
^|9
^|404-417
^|5
^|17
^|834-867
^|14
^|0
^|418-435
^|6
^|17
^|868-871
^|14
^|1
^|436-468
^|6
^|18
^|872-901
^|15
^|1
^|469-470
^|6
^|19
^|902-919
^|15
^|2
^|471-500
^|7
^|19
^|920-935
^|16
^|2
^|501-522
^|7
^|20
^|936-967
^|16
^|3
^|523-533
^|8
^|20
^|968-970
^|17
^|3
^|534-565
^|8
^|21
^|971-100
^|17
^|4
|===

To obatain the corresponding rank numbers for the 0.975 quantile, subtract 
the rank numbers in the table from n+1, where n is the sample size.

Campbell and Gardner calculate the rank indices using the following equations.

stem:[r'=nq-(N_{1-\alpha/2} \times \sqrt{nq(1-q)})]

stem:[s'=1+nq+(N_{1-\alpha/2} \times \sqrt{nq(1-q)})]

where: +
r' is the index of the lower confidence limit rounded to an integer. +
s' is the index of the upper confidence limit rounded to an integer. +
n is the sample size. +
q is the reference interval quantile, usually 0.025 or 0.975. +
alpha is the significance level of the confidence interval, typically 0.1 for 90%. +
N is the inverse of the normal cumulative density function, which in Excel can be calculated with the function NORM.INV(1-alpha/2, 0, 1).

Consider the sample size band 161-187 in the above table where the indices for
the lower confidence limit are 1 and 9. For a sample size of 161, the upper 
confidence limit indices are there for 161+1-9 = 153, and 161+1-1 = 161. In contrast,
for the sample size of 187, the upper confidence limit indices are 187+1-9=179 and 
187+1-1=187.

As might be expected by defining sample size bands, the ranks using the CLSI approach
follow a step wise profile as illustrated below. Stepping also occurs with the Cambell
and Gardner approach due to rounding to integers but it is less apparent than with the 
CLSI approach.

image::clsi_vs_cg_lower.png[title="Rank Indices for Lower Reference Limit Confidence Interval using CLSI EP28-A3c versus Campbell and Gardner 1988 with increasing sample size."]

.Ranks for calculating the confidence limits. LRL=Lower Reference Limit, URL=Upper Reference Limit, UCI Rank=Upper Confidence Interval Rank, LCI Rank=Lower Confidence Interval Rank
[cols="1,1,1,1,1,1,1,1,1"]
|===
|N|CLSI LRL LCI Rank | CLSI LRL UCI Rank | CLSI URL LCI Rank | CLSI URL UCI Rank |C&G LRL LCI Rank |C&G LRL UCI Rank |C&G URL LCI Rank |C&G URL UCI Rank
|119|1|7|113|119|0|7|113|120
|132|1|7|126|132|0|7|126|133
|133|1|8|126|133|0|7|127|134
|160|1|8|153|160|1|8|153|160
|161|1|9|153|161|1|8|154|161
|187|1|9|179|187|1|9|179|187
|188|2|9|180|187|1|9|180|188
|189|2|9|181|188|1|9|181|189
|===

The three edge cases are for sample sizes 119 to 133, where the Campbell 
and Gardner equations round to ranks outside N, in these circumstances
if the calculated rank is &lt; 1 then rank is set to 1, and if rank 
&gt; N, then rank is set to N, which aligns with the CLSI table.

== Box-Cox Transformation

The Box Cox power transformation is often suggested for transforming reference
interval data having a skewed distribution to one having a normal distribution.
The reference interval tools can then be applied to the transformed data to derive
a reference interval and the reference limits can be back calculated using the 
inverse of the transformation.

The transformation is given by:

stem:[y={(\frac{x^{\lambda} - 1}{\lambda}, \lambda \ne 0),( ln(x), \lambda = 0):}]

This tool provides a couple of methods for estimating lambda using a simple grid
search. In both cases a search space must be defined by setting the start of the
range, the end of the range, and the step size. The tool performs a Box-Cox
transform on the population data and assesses the goodness of fit using a Shapiro-
Wilk test or a log likelihood function for every possible lambda in the search
space. The lambda having the best Shapiro-Wilk W or maximum likelihood is then
selected.

The algorithm is not guaranteed to determine the optimal value of lambda but should
return something close for data that is typically used to define reference intervals.
If the returned value of lambda is at the start or end of the search space you selected, 
you will need to extend the search space and try again.

The uncertainty in the estimated value for lambda can be very large if the sample
is small. The charts of lambda versus the log likelihood below have been generated
in R (version 4.5.2) using the boxcox algorithm in the MASS package (version 7.3-65).

It is clear that as the sample size gets smaller, the 95% confidence interval for 
the value of lambda becomes very wide. For this reason it is suggested that samples
used to estimate a value for lambda should contain at least 200 subjects but more
may be required depending on the degree of skewness.

[cols="a,a", frame=none, grid=none]
|===
| image::hist_20000.png[title="Histogram N = 20000"]
| image::boxcox_20000.png[title="Estimated lambda = -0.5"]
|===

[cols="a,a", frame=none, grid=none]
|===
| image::hist_300.png[title="Histogram N = 300"]
| image::boxcox_300.png[title="Estimated lambda = -0.28"]
|===

[cols="a,a", frame=none, grid=none]
|===
| image::hist_100.png[title="Histogram N = 100"]
| image::boxcox_100.png[title="Estimated lambda = -0.29"]
|===

[cols="a,a", frame=none, grid=none]
|===
| image::hist_50.png[title="Histogram N = 50"]
| image::boxcox_50.png[title="Estimated lambda = -0.72"]
|===

[cols="a,a", frame=none, grid=none]
|===
| image::hist_30.png[title="Histogram N = 30"]
| image::boxcox_30.png[title="Estimated lambda = 0.16"]
|===

image::boxcox-tool.png[]

* As for the reference interval tool, the data should be in a single column in
Excel. Select the range of cells containing the data and use the button to 
copy the input range to the taskpane.
* Select the top left cell where you would like the transformed data to be 
saved and copy the cell reference to the add-in taskpane.
* Choose the method for assessing the best lambda value. The default is a
Shapiro-Wilk test.
* Define the search space for lambda. The default is -2 to +2 in steps of 0.01.
* Click on the Transform button to run the analysis.

To back calculate the reference limits and confidence intervals from the transformed
data, use the METOOLS.BOXCOXINV(x, lambda) custom function in Excel. This function
will be available when the add-in taskpane is active.

image::boxcoxinv-function.png[]
